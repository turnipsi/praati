#!/usr/bin/perl -T
# -*- mode: perl; coding: iso-8859-1; -*-
# $Id: praati,v 1.121 2014/05/13 12:00:30 je Exp $

=pod

A sample Apache configuration:

  PerlModule Apache::PerlRun
  PerlTaintCheck On

  <IfDefine PRAATI_DEBUG>
    PerlSetEnv PRAATI_DEBUG 1
    PerlModule CGI::Pretty
  </IfDefine>

  <IfDefine PRAATI_NYTPROF>
    MaxClients 1
    MaxRequestsPerChild 0
    PerlSetEnv NYTPROF "slowops=0"
    PerlSetEnv PRAATI_NYTPROF 1
    PerlSetEnv PERL5OPT -d:NYTProf
  </IfDefine>

  # XXX why does not Files or Location work?
  <Directory /users/*/praati>
    Options +ExecCGI
    PerlHandler Apache::PerlRun
    PerlModule autodie                 \
               autodie::hints          \
               constant                \
               diagnostics             \
               overload                \
               strict                  \
               warnings                \
               BSD::arc4random         \
               CGI                     \
               CGI::Carp               \
               CGI::Cookie             \
               Class::Struct           \
               Crypt::SaltedHash       \
               Data::Dumper            \
               DBD::SQLite             \
               DBI                     \
               Digest::SHA             \
               Email::Valid            \
               Encode                  \
               Encode::Unicode         \
               Exporter                \
               File::Basename          \
               File::Find              \
               File::Glob              \
               List::MoreUtils         \
               List::Util              \
               Locale::Maketext        \
               Math::Trig              \
               MP3::Tag                \
               POSIX                   \
               Scalar::Util            \
               Statistics::Descriptive \
               Tie::Hash::NamedCapture \
               URI::Escape

    PerlSendHeader On
    SetHandler perl-script
  </Directory>

=cut

use autodie;
# use diagnostics;
use strict;
use warnings FATAL => qw(all);

use Praati;

package main {
  if ($ENV{PRAATI_NYTPROF}) {
    my $time = time();
    DB::enable_profile("/tmp/praati-nytprof.out.$$.$time");
  }

  Praati::Controller::main();

  if ($ENV{PRAATI_NYTPROF}) {
    DB::disable_profile();
    DB::finish_profile();
  }
}
